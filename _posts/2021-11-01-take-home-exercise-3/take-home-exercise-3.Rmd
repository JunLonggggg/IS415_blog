---
title: "Take Home Exercise 3"
description: |
  A short description of the post.
author:
  - name: Toh Jun Long
    url: https://linkedin.com/in/tohjunlong
date: 11-01-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE, eval=TRUE, echo=TRUE, message=FALSE,error=FALSE, fig.retina=3}
knitr::opts_chunk$set(echo = TRUE)
```

1.0.0 Context and analysis goal(s):

1.1.o Contexts
Housing is an essential component of household wealth worldwide. Buying a housing has always been a major investment for most people. The price of housing is affected by many factors. Some of them are global in nature such as the general economy of a country or inflation rate. Others can be more specific to the properties themselves. These factors can be further divided to structural and locational factors. Structural factors are variables related to the property themselves such as the size, fitting, and tenure of the property. Locational factors are variables related to the neighbourhood of the properties such as proximity to childcare centre, public transport service and shopping centre.

Hedonic pricing model is used to examine the effect of housing factors as discussed above on the price. Conventional, this model was built by using Ordinary Least Square (OLS) method. However, this method failed to take into consideration that spatial autocorrelation and spatial heterogeneity exist in geographic data sets such as housing transactions. With the existence of spatial autocorrelation, the OLS estimation of hedonic pricing models could lead to biased, inconsistent, or inefficient results (Anselin 1998). In view of this limitation, Geographical Weighted Regression (GWR) was introduced for calibrating hedonic price model for housing.

1.2.1 Exploratory Spatial Data Analysis

In this take-home exercise, we need to build a hedonic pricing models to explain factors affecting the resale prices of public housing in Singapore. The hedonic price models must be built by using appropriate GWR methods.

2. Understanding the Dataset

2.1  Resale flat

Datas:
  Aspatial
+ Resale flat prices based on registration date from jan 2017 onwards.
+ hawker centres
+ supermarkets
Sources:
+ https://data.gov.sg/dataset/resale-flat-prices
+ https://www.onemap.gov.sg/docs/

  Geospatial
+ Train Stations: MRTLRTStnPtt.shp
+ Singapore Planning Subzones: MP14_SUBZONE_WEB_PL.shp

Sources:
+ http://insideairbnb.com/get-the-data.html
+ https://cran.r-project.org/web/packages/onemapsgapi/index.html
+ https://datamall.lta.gov.sg/content/datamall/en/search_datasets.html?searchText=mrt%20stations


3. Importing Required Packages

```{r}
packages = c("maptools","sf","raster","spatstat","tmap","tidyverse", 'sp','olsrr', 'corrplot', 'ggpubr', 'spdep', 'GWmodel','httr','jsonlite','RANN')
for(p in packages){
  if(!require(p, character.only = T)){
      install.packages(p)
  }
  library(p,character.only = T)
}
```

4. Retrieving data from OneMap API

```{r echo =FALSE}
url = "https://developers.onemap.sg/privateapi/themesvc/retrieveTheme"
token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjc5NDgsInVzZXJfaWQiOjc5NDgsImVtYWlsIjoianVubG9uZy50b2guMjAxOUBzbXUuZWR1LnNnIiwiZm9yZXZlciI6ZmFsc2UsImlzcyI6Imh0dHA6XC9cL29tMi5kZmUub25lbWFwLnNnXC9hcGlcL3YyXC91c2VyXC9zZXNzaW9uIiwiaWF0IjoxNjM2MjYzNTcwLCJleHAiOjE2MzY2OTU1NzAsIm5iZiI6MTYzNjI2MzU3MCwianRpIjoiNzU4YjQ3NjE3YWYwM2E5NzhjY2RiYmUzMGQ2ZjRlNjcifQ.CW1QqnmI-_0Z_wxwAylq0hOCdTkNsh1Nnin4c2yNR2g'
```


4.1.1 Supermarket

```{r}
queryName = "supermarkets"
supermarketUrl = paste(c(url,"?queryName=",queryName, "&token=",token),collapse = "")
supermarketUrl
```

```{r}
resp = GET(supermarketUrl)
```

```{r}
supermarkets = fromJSON(rawToChar(resp$content))
supermarkets = do.call("rbind", supermarkets)
supermarkets = supermarkets[c(6,7,8,9,10,11,12,13)]
supermarkets = supermarkets[-1,]
rownames(supermarkets) = 1:nrow(supermarkets)
supermarkets
```

4.1.2 Hawker Centres

```{r}
queryName = "hawkercentre"
hawkerCentresUrl = paste(c(url,"?queryName=",queryName, "&token=",token),collapse = "")
hawkerCentresUrl
```

```{r}
resp = GET(hawkerCentresUrl)
```

```{r}
hawkerCentres = fromJSON(rawToChar(resp$content))
hawkerCentres = do.call("rbind", hawkerCentres)
hawkerCentres = hawkerCentres[c(6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22)]
hawkerCentres = hawkerCentres[-1,]
rownames(hawkerCentres) = 1:nrow(hawkerCentres)
hawkerCentres
```
Saving to csv in local machine for future uses:

```{r eval=FALSE}
write.csv(supermarkets,"data/aspatial/supermarkets.csv",row.names = FALSE)
write.csv(hawkerCentres,"data/aspatial/hawkercentres.csv",row.names = FALSE)
```

5. Importing datas

5.1 importing Geospatial data

5.1.1. importing train station shp file

```{r}
train_station = st_read(dsn = "data/geospatial",
                        layer = "MRTLRTStnPtt")
```

```{r}
st_crs(train_station)
```

Reading in the Planning Subzone Geospatial data.

```{r}
mpsz = st_read(dsn = "data/geospatial",
               layer = "MP14_SUBZONE_WEB_PL")
```

```{r}
st_crs(mpsz)
```

Setting the projected coordinate system to Singapore's standard projection system of 3414.

```{r}
train_station_3414 = st_set_crs(train_station, 3414)
mpsz_3414 = st_set_crs(mpsz, 3414)
```

To check if the change is successful:

```{r echo=TRUE}
st_crs(train_station_3414)
```

```{r}
tm_shape(mpsz_3414) + 
  tm_polygons() +
tm_shape(train_station_3414)+
  tm_dots(alpha = 0.5,
          size = 0.125)
```

Reading in the Aspatial data.

Resale Flats Data:

Adding lat lng:

```{r eval=FALSE}
resale = read_csv("data/aspatial/resale-flat-prices-based-on-registration-date-from-jan-2017-onwards.csv")
glimpse(resale)
```

6. Data Wrangling

6.1 Formating geometric attributes

6.1.1 Splitting LatLng of supermarkets and Hawker Centres

```{r}
supermarkets = supermarkets %>% separate(LatLng,c("Latitude","Longitude"),",")
hawkerCentres = hawkerCentres %>% separate(LatLng,c("Latitude","Longitude"),",")
```

6.1.2 Assigning spatial projection system of supermarkets and Hawker Centres to 3414

```{r}
supermarkets_3414 = st_as_sf(supermarkets,
                          coords = c("Longitude","Latitude"),
                          crs = 4326) %>% 
  st_transform(crs = 3414)
hawkerCentres_3414 = st_as_sf(hawkerCentres,
                          coords = c("Longitude","Latitude"),
                          crs = 4326) %>% 
  st_transform(crs = 3414)
```

6.1.3 Associating geospatial property to resale flat data

```{r eval=FALSE}
resale["Latitude"] = NA
resale["Longitude"] = NA
```

```{r eval=FALSE}
sorted_resale_by_town = resale[order(resale$town),]
```


```{r eval=FALSE}
url = "https://developers.onemap.sg/commonapi/search"

for (row in 1:nrow(resale)){
  print(row)
  searchVal = paste(sorted_resale_by_town[row,'block'], sorted_resale_by_town[row,'street_name'])
  query = list('searchVal' = searchVal, 'returnGeom' = "Y", 'getAddrDetails' ="N")
  resp = GET(url, query = query, verbose())
  sorted_resale_by_town$Latitude[row] = content(resp)$results[[1]]$LATITUDE
  sorted_resale_by_town$Longitude[row] = content(resp)$results[[1]]$LONGITUDE
}
```


```{r eval=FALSE}
write.csv(sorted_resale_by_town,"data/aspatial/resale.csv",row.names = FALSE)
```

Read completed resale file:

```{r}
resale = read_csv("data/aspatial/resale.csv")
glimpse(resale)
```


```{r}
resale_3414 = st_as_sf(resale,
                          coords = c("LONGITUDE","LATITUDE"),
                          crs = 4326) %>% 
  st_transform(crs = 3414)
```

```{r}
tm_shape(mpsz_3414) +
  tm_polygons() +
tm_shape(resale_3414)+
  tm_dots(alpha = 0.5,
          size = 0.125)
```

```{r}
resale_3414 <- resale_3414 %>%
  mutate(`LOG_RESALE_PRICE` = log(resale_price))
```


7. EDA

```{r}
ggplot(data=resale_3414, aes(x=`resale_price`)) +
  geom_histogram(bins=20, color="black", fill="light blue")
```

```{r}
resale_3414 <- resale_3414 %>%
  mutate(`LOG_RESALE_PRICE` = log(resale_price))
```

```{r}
ggplot(data=resale_3414, aes(x=`LOG_RESALE_PRICE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")
```













