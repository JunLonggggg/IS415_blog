---
title: "Take Home Exercise 2"
description: |
  A short description of the post.
author:
  - name: Toh Jun Long
    url: https://linkedin.com/in/tohjunlong
date: 09-20-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE, eval=TRUE, echo=TRUE, message=FALSE,error=FALSE, fig.retina=3}
knitr::opts_chunk$set(echo = FALSE)
```

1.0.0 Context and analysis goal(s):

1.1.o Contexts
Due to the ever-changing world, people all around the world are able to set up simple, small scale business operations within the comfort of our home. 
Our analysis will focus on Airbnb, the leading short-term rentals. While it is not legal to make short-term rentals, enforcement of such legal policy would be rare.

1.2.0 Analysis Goals:

+ Main goal: To determine if distribution of Airbnb listings are affected by factors such as as existing hotels, public transport options and other notable amenities

1.2.1 Exploratory Spatial Data Analysis

+ Derive kernel density maps of Airbnb listings, hotel, MRT services and tourist attractions.
+ Display kernel density maps on openstreetmap of Singapore. Describe the spatial patterns derived from the kernel density maps.

1.2.2 Second-Order Spatial Point Patterns Analysis (2nd order SPPA)

+ Formulate null and alternative hypothesis, select confidence level
+ perform tests using "2nd order SPPA" technique
+ Draw statistical conclusions


2. Understanding the Dataset

2.1  Airbnb listings

Datas:
  Aspatial
+ Airbnb listing at 30th June 2019: 30062019.csv
+ Airbnb listing at 29th June 2021: 29062021.csv

Source: http://insideairbnb.com/get-the-data.html

  Geospatial
+ Train Stations: MRTLRTStnPtt.shp
+ 



3. Importing Required Packages

```{r}
packages = c("maptools","sf","raster","spatstat","tmap","tidyverse", "plotly","ggthemes", 'sp', 'rgdal', 'spNetwork')
for(p in packages){
  if(!require(p, character.only = T)){
      install.packages(p)
  }
  library(p,character.only = T)
}
```

4. Importing datas

4.1 importing Geospatial data

4.1.1. importing train station shp file

```{r}
train_station = st_read(dsn = "data/geospatial",
                        layer = "MRTLRTStnPtt")
```

```{r}
st_crs(train_station)
```

Reading in the Planning Subzone Geospatial data.

```{r}
mpsz = st_read(dsn = "data/geospatial",
               layer = "MP14_SUBZONE_WEB_PL")
```

```{r}
st_crs(mpsz)
```

```{r}
sg_sf = st_read(dsn = "data/geospatial",
                layer = "CostalOutline")
```

```{r}
st_crs(sg_sf)
```



Setting the projected coordinate system to Singapore's standard projection system of 3414.

```{r}
train_station_3414 = st_set_crs(train_station, 3414)
mpsz_3414 = st_set_crs(mpsz, 3414)
sg_sf_3414 = st_set_crs(sg_sf, 3414)
```

To check if the change is successful:

```{r echo=TRUE}
st_crs(sg_sf_3414)
```

Doing a plot to show the spatial points illustrating the mrt stations in the subzones

```{r}
tm_shape(mpsz_3414) + 
  tm_polygons() +
tm_shape(train_station_3414)+
  tm_dots(alpha = 0.5,
          size = 0.125)
```

Reading in the Aspatial data.

Airbnb Datas:

```{r}
airbnb_2021 = read_csv("data/aspatial/Airbnb_listing/29062021.csv")
airbnb_2019 = read_csv("data/aspatial/Airbnb_listing/30062019.csv")
```

OneMap's Datas:

Hotel:

```{r}
hotels = read_csv("data/aspatial/OneMap_Data/hotels.csv")
```

Tourism spots:

```{r}
tourism = read_csv("data/aspatial/OneMap_Data/tourism.csv") %>% 
    drop_na(LATITUDE)
```

Transforming latitude and longitude of each aspatial data to Singapore projection system

```{r}
airbnb_2019_sf = st_as_sf(airbnb_2019,
                          coords = c("longitude","latitude"),
                          crs = 4326) %>% 
  st_transform(crs = 3414)
airbnb_2021_sf = st_as_sf(airbnb_2021,
                          coords = c("longitude","latitude"),
                          crs = 4326) %>% 
  st_transform(crs = 3414)
hotels_sf = st_as_sf(hotels,
                     coords = c("Lng","Lat"),
                     crs = 4326) %>% 
  st_transform(crs = 3414)
tourism_sf = st_as_sf(tourism,
                     coords = c("LONGTITUDE","LATITUDE"),
                     crs = 4326) %>% 
  st_transform(crs = 3414)
```

## Section A: Airbnb Distribution in 2019

### Exploratory Spatial Data Analysis

First let us plot the spatial points of each dataset onto the map (mpsz) to look at the spread of Airbnb Listings, Hotels, Tourism Spots and Mrt Stations

```{r}
airbnb_2019_map = tm_shape(mpsz_3414)+
  tm_polygons() +
  tm_shape(airbnb_2019_sf)+
  tm_dots(alpha = 0.5,
          size = 0.05,
          col = "#CC0033")
hotel_map = tm_shape(mpsz_3414)+
  tm_polygons() +
  tm_shape(hotels_sf)+
  tm_dots(alpha = 0.5,
          size = 0.05,
          col = "#0066CC")
tourism_map = tm_shape(mpsz_3414)+
  tm_polygons() +
  tm_shape(tourism_sf)+
  tm_dots(alpha = 0.5,
          size = 0.05,
          col = "#FF6600")
train_station_map = tm_shape(mpsz_3414) +
tm_polygons() +
tm_shape(train_station_3414)+
tm_dots(alpha = 0.5,
        size = 0.05,
        col = "#00940c")
tmap_arrange(airbnb_2019_map, hotel_map, tourism_map,train_station_map,ncol = 2, nrow = 2)
```

From the map, we can vaguely tell that there are higher concentation of airbnb listing along the southern central part of the island, where Sentosa and other recreational activities are commonly found in Singapore, as illustrated by the orange spatial points for "Tourism" and blue spatial points for "hotels".

This is merely a visual gauge of the concentration, thus we should calculate the count and density of airbnb listings, hotels and tourisms spots in each planning area.

We shall now move to plot the kernel density for each of the 4 spatial points dataset available. i.e. Airbnb listing, mrt station, tourism and hotels.

### Geospatial data wrangling

#### 1. Converting sf data frames to sp's Spatial* class

```{r echo =TRUE}
airbnb_2019 = as_Spatial(airbnb_2019_sf)
train_station = as_Spatial(train_station_3414)
tourism = as_Spatial(tourism_sf)
hotels = as_Spatial(hotels_sf)
sg = as_Spatial(sg_sf_3414)
```

To confirm if the conversion to Spatial* class was successful

```{r}
airbnb_2019
```

```{r}
train_station
```

```{r}
tourism
```

```{r}
hotels
```

```{r}
sg
```


#### 2. Converting Spatial* class into generic sp format

```{r}
airbnb_2019_sp = as(airbnb_2019,"SpatialPoints")
train_station_sp = as(train_station,"SpatialPoints")
tourism_sp = as(tourism,"SpatialPoints")
hotels_sp = as(hotels,"SpatialPoints")
sg_sp <- as(sg, "SpatialPolygons")
```

```{r}
airbnb_2019_sp
```

```{r}
train_station_sp
```

```{r}
tourism_sp
```

```{r}
hotels_sp
```

#### 3. Converting sp format into spatstat's ppp format

Airbnb 2019:

```{r}
airbnb_2019_ppp = as(airbnb_2019_sp,"ppp")
airbnb_2019_ppp
```

```{r}
plot(airbnb_2019_ppp)
```

```{r}
summary(airbnb_2019_ppp)
```

based on the above output, we can tell that there is duplicated points and thus should identify and handle them as necessary.

To confirm:

```{r}
any(duplicated(airbnb_2019_ppp))
```

To check the number of locations with duplicated points.

```{r}
sum(multiplicity(airbnb_2019_ppp)>1)
```

We will use the jittering solution to handle the duplicates, since any drop of data could potentially mean loss of useful information.

```{r}
airbnb_2019_ppp_jit =rjitter(airbnb_2019_ppp,
                             retry = TRUE,
                             nsim = 1,
                             drop =TRUE)
```


```{r}
any(duplicated(airbnb_2019_ppp_jit))
```

We have successfully ensure that all locations do not have duplicated points for the airbnb ppp object.

Now to convert and check the other sp objects for duplicated values, as unlikely as it is.

train station:

```{r}
train_station_ppp = as(train_station_sp,"ppp")
train_station_ppp
```

```{r}
plot(train_station_ppp)
```

```{r}
summary(train_station_ppp)
```

No duplicates for train stations.

Tourism:

```{r}
tourism_ppp = as(tourism_sp,"ppp")
tourism_ppp
```

```{r}
summary(tourism_ppp)
```

```{r}
any(duplicated(tourism_ppp))
```

Checking the number of duplicated points:

```{r}
sum(multiplicity(tourism_ppp)>1)
```

Again, We will use the jittering solution to handle the duplicates, since any drop of data could potentially mean loss of useful information.

```{r}
tourism_ppp_jit =rjitter(tourism_ppp,
                             retry = TRUE,
                             nsim = 1,
                             drop =TRUE)
```


```{r}
any(duplicated(tourism_ppp_jit))
```

Lastly, Hotels:

```{r}
hotels_ppp = as(hotels_sp,"ppp")
hotels_ppp
```

```{r}
summary(hotels_ppp)
```

duplicated points are detected.

To confirm:

```{r}
any(duplicated(hotels_ppp))
```

Checking the number of duplicated points:

```{r}
sum(multiplicity(hotels_ppp)>1)
```

Again, We will use the jittering solution to handle the duplicates.

```{r}
hotels_ppp_jit =rjitter(hotels_ppp,
                             retry = TRUE,
                             nsim = 1,
                             drop =TRUE)
```


```{r}
any(duplicated(hotels_ppp_jit))
```

Now all ppp objects will not have any overlappiing spatial points.

### Creating owin object

```{r}
sg_owin <- as(sg_sp, "owin")
```

```{r}
summary(sg_owin)
```


```{r}
plot(sg_owin)
```

### combining the point events objects with the owin object

#### Airbnb 2019

```{r}
airbnb_2019_SG_ppp_jit  = airbnb_2019_ppp_jit[sg_owin]
```

```{r}
plot(airbnb_2019_SG_ppp_jit)
```

#### Train Station

```{r}
train_station_SG_ppp  = train_station_ppp[sg_owin]
```

```{r}
plot(train_station_SG_ppp)
```

#### Tourism

```{r}
tourism_SG_ppp_jit  = tourism_ppp_jit[sg_owin]
```

```{r}
plot(tourism_SG_ppp_jit)
```

#### Hotels

```{r}
hotels_SG_ppp_jit  = hotels_ppp_jit[sg_owin]
```

```{r}
plot(hotels_SG_ppp_jit)
```

### KDE

For the KDEs, the following settings are used:
+ adaptive bandwidth: since the airbnb distribution showed signs of clustering in the previous point plots.

```{r}
kde_airbnb_2019_SG_ppp_jit_adaptive = adaptive.density(airbnb_2019_SG_ppp_jit, method="kernel")
plot(kde_airbnb_2019_SG_ppp_jit_adaptive)
```

From the kde plot for Airbnb listing 2019 above, we can see that the density range from 0 to 0.00175.

```{r}
kde_train_station_SG_ppp_jit_adaptive = adaptive.density(train_station_SG_ppp, method="kernel")
plot(kde_train_station_SG_ppp_jit_adaptive)
```

```{r}
kde_tourism_SG_ppp_jit_adaptive = adaptive.density(tourism_SG_ppp_jit, method="kernel")
plot(kde_tourism_SG_ppp_jit_adaptive)
```

```{r}
kde_hotels_SG_ppp_jit_adaptive = adaptive.density(hotels_SG_ppp_jit, method="kernel")
plot(kde_hotels_SG_ppp_jit_adaptive)
```

#### Converting KDE output into grid object

```{r}
gridded_kde_airbnb_2019_SG_ppp_jit_adaptive <- as.SpatialGridDataFrame.im(kde_airbnb_2019_SG_ppp_jit_adaptive)
spplot(gridded_kde_airbnb_2019_SG_ppp_jit_adaptive)
```

```{r}
gridded_kde_train_station_SG_ppp_jit_adaptive <- as.SpatialGridDataFrame.im(kde_train_station_SG_ppp_jit_adaptive)
spplot(gridded_kde_train_station_SG_ppp_jit_adaptive)
```

```{r}
gridded_kde_tourism_SG_ppp_jit_adaptive <- as.SpatialGridDataFrame.im(kde_tourism_SG_ppp_jit_adaptive)
spplot(gridded_kde_tourism_SG_ppp_jit_adaptive)
```

```{r}
gridded_kde_hotels_SG_ppp_jit_adaptive <- as.SpatialGridDataFrame.im(kde_hotels_SG_ppp_jit_adaptive)
spplot(gridded_kde_hotels_SG_ppp_jit_adaptive)
```

#### Converting grid output into raster

```{r}
kde_airbnb_2019_SG_ppp_jit_adaptive_raster = raster(gridded_kde_airbnb_2019_SG_ppp_jit_adaptive)
kde_train_station_SG_ppp_jit_adaptive_raster = raster(gridded_kde_train_station_SG_ppp_jit_adaptive)
kde_tourism_SG_ppp_jit_adaptive_raster = raster(gridded_kde_tourism_SG_ppp_jit_adaptive)
kde_hotels_SG_ppp_jit_adaptive_raster = raster(gridded_kde_hotels_SG_ppp_jit_adaptive)
```

```{r}
kde_airbnb_2019_SG_ppp_jit_adaptive_raster
```

```{r}
kde_train_station_SG_ppp_jit_adaptive_raster
```

```{r}
kde_tourism_SG_ppp_jit_adaptive_raster
```

```{r}
kde_hotels_SG_ppp_jit_adaptive_raster
```

Setting back the crs/projection system information

```{r}
projection(kde_airbnb_2019_SG_ppp_jit_adaptive_raster) = CRS("+init=EPSG:3414")
kde_airbnb_2019_SG_ppp_jit_adaptive_raster
```

```{r}
projection(kde_train_station_SG_ppp_jit_adaptive_raster) = CRS("+init=EPSG:3414")
kde_train_station_SG_ppp_jit_adaptive_raster
```

```{r}
projection(kde_tourism_SG_ppp_jit_adaptive_raster) = CRS("+init=EPSG:3414")
kde_tourism_SG_ppp_jit_adaptive_raster
```

```{r}
projection(kde_hotels_SG_ppp_jit_adaptive_raster) = CRS("+init=EPSG:3414")
kde_hotels_SG_ppp_jit_adaptive_raster
```

Displaying the raster on a map using tmap package

```{r}
tmap_mode("plot")
airbnb_raster_map =
  tm_shape(kde_airbnb_2019_SG_ppp_jit_adaptive_raster)+
  tm_raster("v")+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
train_station_raster_map = tm_shape(kde_train_station_SG_ppp_jit_adaptive_raster)+
  tm_raster("v")+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
tourism_raster_map = tm_shape(kde_tourism_SG_ppp_jit_adaptive_raster)+
  tm_raster("v")+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
hotels_raster_map = tm_shape(kde_hotels_SG_ppp_jit_adaptive_raster)+
  tm_raster("v")+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
tmap_arrange(airbnb_raster_map,train_station_raster_map,tourism_raster_map,hotels_raster_map,ncol=2,nrow = 2)
```

Using openstreetmap as the basemap

```{r}
tmap_mode("view")
airbnb_raster_map = 
tm_basemap("OpenStreetMap") +
tm_shape(kde_airbnb_2019_SG_ppp_jit_adaptive_raster) + 
  tm_raster("v", palette = "Reds", alpha = 0.5)  +
  tm_layout(legend.position = c("right", "bottom"), frame = FALSE)
train_station_raster_map = 
  tm_basemap("OpenStreetMap") +
  tm_shape(kde_train_station_SG_ppp_jit_adaptive_raster)+
  tm_raster("v", palette = "Blues", alpha = 0.5)+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
tourism_raster_map =
  tm_basemap("OpenStreetMap") +
  tm_shape(kde_tourism_SG_ppp_jit_adaptive_raster)+
  tm_raster("v", palette = "Greens", alpha = 0.5)+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
hotels_raster_map =
  tm_basemap("OpenStreetMap") +
  tm_shape(kde_hotels_SG_ppp_jit_adaptive_raster)+
  tm_raster("v", palette = "Oranges", alpha = 0.5)+
  tm_layout(legend.position = c("right","bottom"),frame = FALSE)
tmap_arrange(airbnb_raster_map,train_station_raster_map,tourism_raster_map,hotels_raster_map,ncol=2,nrow = 2)
```

```{r}
tmap_mode("plot")
```

























